# CAEN Digitizer Parser

A comprehensive Python library for parsing and analyzing data from CAEN digitizers, supporting multiple file formats including XML configuration files and binary data files (RAW, WBIN).

## ðŸš€ Features

- **Multi-format support**: Parse XML configuration files, RAW binary files (Scope Software)
- **Multiple digitizer models**: Support for WaveDump2 bin format
- **Pandas integration**: Convert waveform data to pandas DataFrames
- **Flexible measurement units**: Support for voltage or ADC counts

## ðŸ“¦ Installation

### Prerequisites

- Python 3.12+
- C++11 compatible compiler (gcc/g++ on Linux, Visual Studio on Windows)
- pip package manager

### Create Virtual Environment (Recommended)

```bash
# Create virtual environment
python -m venv venv

# Activate virtual environment
# On Linux/Mac:
source venv/bin/activate
# On Windows:
venv\Scripts\activate
```

### Install from Source

```bash
# Clone the repository
git clone <repository-url>
cd MainzDigitizer

# Install in development mode (recommended)
pip install -e .

# Or install normally
pip install .
```

### Dependencies

The following packages will be installed automatically:

- `pandas >= 2.3.0` - Data manipulation and analysis
- `pybind11 >= 2.6.0` - C++ binding library
- `numpy >= 1.26.0` - Numerical computing (via pandas)

### Verify Installation

```bash
# Test the command line interface
mainz-digitizer --help

# Or test Python import
python -c "import caenParser; print('Installation successful!')"
```

## ðŸ”§ Build Process

The installation includes compiling C++ extensions for efficient binary file parsing:

### Manual Build (if needed)

```bash
# Clean previous builds
make clean

# Build and install
make install

# Or using setuptools directly
python setup.py build_ext --inplace
```

### Common Installation Issues

#### Missing Compiler
**Linux (Ubuntu/Debian):**
```bash
sudo apt update
sudo apt install build-essential python3-dev
```

**Linux (CentOS/RHEL):**
```bash
sudo yum groupinstall "Development Tools"
sudo yum install python3-devel
```

**macOS:**
```bash
xcode-select --install
```

#### Windows
Install Visual Studio Build Tools or Visual Studio Community with C++ support.

## ðŸŽ¯ Quick Start

### Command Line Interface
```bash
# Run the main application
mainz-digitizer

# Or using Python module
python -m caenParser
```

### Python API

```python
from caenParser import PersistenceController

# Load XML configuration
controller = PersistenceController()
controller.load_file("config.xml", file_type="xml")

# Access digitizer information
digitizers = controller.get_digitizers()
settings = controller.get_settings()

print(f"Found {len(digitizers)} digitizers")
```

## ðŸ”„ Updating

```bash
# If installed with -e flag
git pull origin main
pip install -e . --force-reinstall

# If installed normally
git pull origin main
pip install . --upgrade
```

## ðŸ—‘ï¸ Uninstallation

```bash
pip uninstall caenParser
```
## ðŸ” Troubleshooting

### Import Errors
If you get import errors, ensure your Python path includes the package:
```bash
python -c "import sys; print(sys.path)"
```

### Build Errors
Check that you have all required development tools:
```bash
gcc --version  # Should show compiler version
python --version  # Should be 3.12+
```

### Permission Errors
On Linux/Mac, you might need to use `sudo` or check file permissions:
```bash
# Don't use sudo with pip in virtual environments
# Instead, check virtual environment activation
which python  # Should point to venv/bin/python
```

## ðŸ“‹ System Requirements

- **Operating System**: Linux, macOS, Windows
- **Python**: 3.12 or higher
- **Memory**: At least 512MB RAM
- **Disk Space**: ~50MB for installation
- **Network**: Required for downloading dependencies

## WaveDump2BinParser

`WaveDump2BinParser` is a class designed for efficient parsing of binary files generated by WaveDump2. Instead of loading the entire file into memoryâ€”which could lead to memory crashes with large filesâ€”it takes the path to the binary file and returns an iterator over its events. This iterator yields one event at a time, enabling memory-efficient processing and analysis of event data.

### Iterating Over Events with `WaveDump2BinParser`

To process events from a WaveDump2 binary file, use the `WaveDump2BinParser` class as an iterator. Each iteration yields a single event, allowing you to analyze large files without loading everything into memory.

#### Example Usage

```python
from caenParser import WaveDump2BinParser

parser = WaveDump2BinParser("data.bin")
for event in parser:
    # Process each event
    print(event)
### Event Format

Each event yielded by `WaveDump2BinParser` is a dictionary with the following structure:

```python
{
    'event_num': event_num,            # Event number (int)
    'timestamp': timestamp,            # Timestamp of the event (int or float)
    'samples': samples,                # Number of samples per channel (int)
    'sampling_period_ns': samp_period, # Sampling period in nanoseconds (int)
    'channels': channels,              # Number of channels (int)
    'waveform': waveform               # List of waveforms, one per channel
}
```

- **event_num**: Sequential number of the event.
- **timestamp**: Time at which the event was recorded.
- **samples**: Number of samples in each waveform.
- **sampling_period_ns**: Time interval between samples (nanoseconds).
- **channels**: Number of digitizer channels in the event.
- **waveform**: List containing the waveform data for each channel.

The `waveform` field is a list where each element corresponds to the waveform data for a channel, typically as a NumPy array or list of sample values.

The WaveDump2BinParser object has to be initialized in the corresponding mode depending on the output_file configuration of the file one intends to parse.

The default mode is multiple channels of one board in one file. The other two formats selectable, which are mutually exclusive, are: 
- **One File for Each Channel**: In this format, each channel of the output is stored in a different file. (To activate, set *one_file_each_channel = true* upon initialization) 
- **Multiple Boards One File**: In this format, all channels of all boards are stored in the same file (To activate, set *multiboard = true* upon initialization)

There is also the option to change between two waveform data formats:

- **Float**: The values of the waveform correspond to the signal voltage (in mV) and no conversion is needed
- **ADC_Counts**: The values are the ADCcount value, so a conversion is needed to be able to extract the volatge value (No method provided to do so inside the class, so it has to be performed after getting the waveform


## Parser Class

The API also provides a class object named Parser (it is actually the domain controller in the source code)
. This class has the following public attributes and methods.

### Attributes and Getters
- `events_ids`: Returns a list[int] of the ids of the events loaded.
- `settings_ids`: Returns a list[int] of the ids of the settings loaded.
- `digitizers_ids`: Returns a list[str] of the ids of the digitizers loaded.
- `get_digitizer(id) -> Digitizer`: Returns the digitizer corresponding to the id provided if it is valid, None otherwise.
- `get_settings(id) -> Settings`: Returns the settings object corresponding to the id provided if it's loaded, None otherwise.
- `get_event(id) -> Event`: Returns the Event corresponding to the id provided if it is loaded, None otherwise 

**Note**: All methods return the original object, so one has to be careful about the modifications it does. The getters are thought more of as a future expansion of the class, not to be used right now. The expected way of using the class will be explained below.

### Methods 
- `set_measure_magnitude(name:str) -> None`: Allows to set the output magnitude for the waveforms. default is ADCCounts, but can be set to "voltage" (in mV).

- `loadFile(file_path:str)-> None`: Loads and parses the file, extracting all the information from it. The file extension can be .xml or .bin, and the program itself decides how to parse it. When called, the new objects extracted from the file are added to the list without erasing the existing ones.

- `get_data_frame(event_id:int, channel:int) -> pandas.DataFrame`: Returns the waveform of the channel of the event_id provided, if it's valid, None otherwise. The dataframe has the data already converted to the current magnitude selected.

- `get_t_graph(event_id:int, channel:int) -> ROOT.TGraph`: Returns the waveform data of the channel and the event_id provided if the event exists, None otherwise. in the current magnitude units.

- `clear()`: This methos cleans all the digitizers, settings and events and leaves the class empty.
